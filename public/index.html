<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noqeder PRO</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0c;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
        .welcome-screen {
            position: fixed;
            inset: 0;
            background: #0a0a0c;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .hidden {
            display: none !important;
        }

        .auth-card {
            width: 450px;
            padding: 40px;
            background: #12121a;
            border: 2px solid #2a2a35;
            border-radius: 32px;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo span {
            display: inline-block;
            font-size: 48px;
            font-weight: 800;
            letter-spacing: 4px;
            color: #fff;
            background: #000;
            padding: 8px 24px;
            border-radius: 60px;
            border: 2px solid #fff;
            animation: pulse 2s infinite;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: #1a1a24;
            border: 2px solid #2a2a35;
            border-radius: 30px;
            color: #888;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-tab.active {
            background: #fff;
            color: #000;
            border-color: #fff;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 16px;
            background: #0f0f15;
            border: 2px solid #2a2a35;
            border-radius: 16px;
            color: #fff;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            border-color: #fff;
        }

        .input-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: #fff;
            color: #000;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255,255,255,0.2);
        }

        .btn.small {
            padding: 12px;
            font-size: 14px;
            margin-top: 10px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* –ê–≤–∞—Ç–∞—Ä */
        .avatar-upload {
            margin-bottom: 24px;
            text-align: center;
        }

        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #1a1a24;
            border: 3px solid #2a2a35;
            margin: 0 auto 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .avatar-preview:hover {
            border-color: #fff;
            transform: scale(1.05);
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 32px;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç */
        .chat-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: 100vh;
        }

        /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .chats-sidebar {
            background: #12121a;
            border-right: 2px solid #2a2a35;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 2px solid #2a2a35;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header h2 span {
            background: #000;
            padding: 4px 12px;
            border-radius: 40px;
            border: 2px solid #fff;
            font-size: 20px;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #1a1a24;
            border: 2px solid #2a2a35;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .icon-btn:hover {
            background: #fff;
            border-color: #fff;
            transform: scale(1.1) rotate(5deg);
        }

        /* –ü—Ä–æ—Ñ–∏–ª—å –≤ —Å–∞–π–¥–±–∞—Ä–µ */
        .user-card {
            margin: 20px;
            padding: 16px;
            background: #1a1a24;
            border-radius: 20px;
            border: 2px solid #2a2a35;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-card:hover {
            border-color: #fff;
            transform: translateX(5px);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #1a1a24;
            border: 2px solid #2a2a35;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-avatar.small {
            width: 36px;
            height: 36px;
        }

        .user-info {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-username {
            font-size: 12px;
            color: #888;
        }

        /* –ü–æ–∏—Å–∫ */
        .search-section {
            padding: 0 20px 20px 20px;
        }

        .search-title {
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .search-container {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            font-size: 16px;
        }

        .search-input {
            width: 100%;
            padding: 12px 12px 12px 48px;
            background: #0f0f15;
            border: 2px solid #2a2a35;
            border-radius: 30px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }

        .search-input:focus {
            border-color: #fff;
        }

        .search-results {
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #1a1a24;
            border-radius: 12px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-result-item:hover {
            background: #2a2a35;
            transform: translateX(5px);
        }

        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .chats-list {
            flex: 1;
            padding: 0 20px;
            overflow-y: auto;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #1a1a24;
            border-radius: 16px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .chat-item:hover {
            background: #2a2a35;
            transform: translateX(5px);
            border-color: #fff;
        }

        .chat-item.selected {
            border-color: #fff;
            background: #2a2a35;
        }

        .chat-info {
            flex: 1;
            margin-left: 12px;
            overflow: hidden;
        }

        .chat-name {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-last-message {
            font-size: 12px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å */
        .chat-main {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .chat-header {
            padding: 16px 24px;
            border-bottom: 2px solid #2a2a35;
            background: #12121a;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .messages-area {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 70%;
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease;
        }

        .message.own {
            align-self: flex-end;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #1a1a24;
            border: 2px solid #2a2a35;
            overflow: hidden;
            cursor: pointer;
            flex-shrink: 0;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            background: #1a1a24;
            padding: 12px 16px;
            border-radius: 18px;
            word-break: break-word;
        }

        .message.own .message-content {
            background: #fff;
            color: #000;
        }

        .message-author {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 4px;
            font-weight: 600;
            cursor: pointer;
        }

        .message.own .message-author {
            color: #666;
        }

        .message-time {
            font-size: 10px;
            color: #888;
            margin-top: 4px;
            text-align: right;
        }

        /* –§–∞–π–ª—ã */
        .file-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin: 4px 0;
        }

        .file-icon {
            font-size: 32px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .file-size {
            font-size: 11px;
            color: #888;
        }

        .file-download {
            padding: 6px 12px;
            background: #fff;
            color: #000;
            border-radius: 20px;
            text-decoration: none;
            font-size: 12px;
        }

        .message-image {
            max-width: 250px;
            max-height: 200px;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 4px;
        }

        .message-video {
            max-width: 250px;
            max-height: 200px;
            border-radius: 12px;
            margin-top: 4px;
        }

        .system-message {
            text-align: center;
            font-size: 12px;
            color: #888;
            padding: 8px 16px;
            background: #1a1a24;
            border-radius: 40px;
            align-self: center;
        }

        /* –ö–æ–º–ø–æ–∑–µ—Ä */
        .composer {
            padding: 16px 24px 24px 24px;
            border-top: 2px solid #2a2a35;
            background: #12121a;
        }

        .composer-tools {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .media-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #1a1a24;
            border: 2px solid #2a2a35;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .media-btn:hover {
            background: #fff;
            border-color: #fff;
            transform: scale(1.1);
        }

        .composer-row {
            display: flex;
            gap: 12px;
        }

        .composer input {
            flex: 1;
            padding: 16px 20px;
            background: #0f0f15;
            border: 2px solid #2a2a35;
            border-radius: 30px;
            color: #fff;
            font-size: 16px;
            outline: none;
        }

        .composer input:focus {
            border-color: #fff;
        }

        .composer button {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            border: none;
            background: #fff;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .composer button:hover {
            transform: scale(1.1);
        }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
        .upload-preview {
            margin-top: 12px;
            padding: 12px;
            background: #1a1a24;
            border: 2px solid #2a2a35;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .upload-preview.hidden {
            display: none;
        }

        .preview-info {
            flex: 1;
        }

        .preview-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .preview-size {
            font-size: 12px;
            color: #888;
        }

        .progress-bar {
            height: 4px;
            background: #2a2a35;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: #fff;
            width: 0%;
            transition: width 0.3s ease;
        }

        .preview-cancel {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #ff4444;
            color: white;
            border: none;
            cursor: pointer;
        }

        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .profile-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 450px;
            background: #12121a;
            border: 2px solid #2a2a35;
            border-radius: 32px;
            padding: 32px;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .profile-modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .profile-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .profile-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid #fff;
            overflow: hidden;
        }

        .profile-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-title h3 {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .profile-title .username {
            color: #888;
            font-size: 14px;
        }

        .profile-section {
            margin-bottom: 20px;
        }

        .profile-section-title {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .profile-bio {
            background: #1a1a24;
            padding: 16px;
            border-radius: 16px;
            font-size: 14px;
            border: 2px solid #2a2a35;
        }

        .profile-music-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #1a1a24;
            border-radius: 16px;
            border: 2px solid #2a2a35;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loader-container {
            display: flex;
            justify-content: center;
            padding: 20px;
        }
    </style>
</head>
<body>

<!-- –û–≤–µ—Ä–ª–µ–π –ø—Ä–æ—Ñ–∏–ª—è -->
<div class="profile-overlay" id="profileOverlay" onclick="closeProfileModal()"></div>
<div class="profile-modal" id="profileModal">
    <div class="profile-header">
        <div class="profile-avatar-large" id="modalAvatar">
            <img src="" id="modalAvatarImg">
        </div>
        <div class="profile-title">
            <h3 id="modalName"></h3>
            <div class="username" id="modalUsername"></div>
        </div>
    </div>

    <div class="profile-section">
        <div class="profile-section-title">–û –°–ï–ë–ï</div>
        <div class="profile-bio" id="modalBio"></div>
    </div>

    <div class="profile-section">
        <div class="profile-section-title">–ú–£–ó–´–ö–ê</div>
        <div id="modalMusicList"></div>
    </div>

    <button class="btn small" onclick="closeProfileModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
<div class="welcome-screen" id="welcomeScreen">
    <div class="auth-card">
        <div class="logo"><span>NOQEDER</span></div>
        
        <div class="auth-tabs">
            <div class="auth-tab active" onclick="switchAuthTab('login')">–í—Ö–æ–¥</div>
            <div class="auth-tab" onclick="switchAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
        </div>

        <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
        <div class="auth-form active" id="loginForm">
            <div class="input-group">
                <label>–Æ–ó–ï–†–ù–ï–ô–ú</label>
                <input type="text" id="loginUsername" placeholder="@username">
            </div>
            <div class="input-group">
                <label>–ü–ê–†–û–õ–¨</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>
        </div>

        <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
        <div class="auth-form" id="registerForm">
            <div class="avatar-upload">
                <div class="avatar-preview" id="registerAvatarPreview" onclick="document.getElementById('registerAvatarInput').click()">
                    <div class="avatar-placeholder" id="registerAvatarPlaceholder">+</div>
                    <img id="registerAvatarImage" src="" style="display: none;">
                </div>
                <input type="file" id="registerAvatarInput" accept="image/*" style="display: none;">
            </div>

            <div class="input-group">
                <label>–Æ–ó–ï–†–ù–ï–ô–ú</label>
                <input type="text" id="registerUsername" placeholder="@username">
            </div>
            <div class="input-group">
                <label>–ò–ú–Ø</label>
                <input type="text" id="registerName" placeholder="–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç">
            </div>
            <div class="input-group">
                <label>–ü–ê–†–û–õ–¨</label>
                <input type="password" id="registerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <div class="input-group">
                <label>–û –°–ï–ë–ï</label>
                <textarea id="registerBio" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ..."></textarea>
            </div>
            <div class="input-group">
                <label>–õ–Æ–ë–ò–ú–ê–Ø –ú–£–ó–´–ö–ê</label>
                <input type="text" id="registerMusicTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞">
            </div>
            <div class="input-group">
                <label>–ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨</label>
                <input type="text" id="registerMusicArtist" placeholder="–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å">
            </div>
            <button class="btn" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </div>
    </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
<div class="chat-container hidden" id="chatContainer">
    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="chats-sidebar">
        <div class="sidebar-header">
            <h2><span>NOQEDER</span></h2>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="user-card" id="userCard" onclick="showMyProfile()">
            <div class="user-avatar" id="userAvatar">
                <img src="" id="userAvatarImg">
            </div>
            <div class="user-info">
                <div class="user-name" id="userName"></div>
                <div class="user-username" id="userUsername"></div>
            </div>
        </div>

        <!-- –ü–æ–∏—Å–∫ -->
        <div class="search-section">
            <div class="search-title">–ù–ê–ô–¢–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø</div>
            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" id="searchInput" placeholder="@username" oninput="searchUsers()">
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
        <div class="chats-list" id="chatsList"></div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="chat-main">
        <div class="chat-header">
            <div class="header-left" onclick="showCurrentChatProfile()">
                <div class="user-avatar small" id="chatAvatar">
                    <img src="" id="chatAvatarImg">
                </div>
                <span id="chatTitle">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</span>
            </div>
        </div>

        <div class="messages-area" id="messagesArea">
            <div class="system-message">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Noqeder PRO</div>
        </div>

        <div class="composer">
            <div class="composer-tools">
                <div class="media-btn" onclick="document.getElementById('fileInput').click()">üìÅ</div>
                <div class="media-btn" onclick="document.getElementById('imageInput').click()">üñºÔ∏è</div>
                <div class="media-btn" onclick="document.getElementById('videoInput').click()">üé•</div>
            </div>

            <input type="file" id="fileInput" style="display: none" onchange="handleFileSelect(this.files[0])">
            <input type="file" id="imageInput" style="display: none" accept="image/*" onchange="handleFileSelect(this.files[0])">
            <input type="file" id="videoInput" style="display: none" accept="video/*" onchange="handleFileSelect(this.files[0])">

            <div class="upload-preview hidden" id="uploadPreview">
                <div class="file-icon">üìÑ</div>
                <div class="preview-info">
                    <div class="preview-name" id="previewName"></div>
                    <div class="preview-size" id="previewSize"></div>
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
                <button class="preview-cancel" onclick="cancelUpload()">‚úï</button>
            </div>

            <div class="composer-row">
                <input id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" autocomplete="off" disabled>
                <button onclick="sendMessage()" disabled>‚Üí</button>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let currentUser = null;
    let currentFile = null;
    let users = [];
    let chats = [];
    let selectedChat = null;
    let currentPage = 1;
    let loading = false;
    let hasMore = true;

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const welcomeScreen = document.getElementById('welcomeScreen');
    const chatContainer = document.getElementById('chatContainer');
    const messagesArea = document.getElementById('messagesArea');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.querySelector('.composer button');
    const uploadPreview = document.getElementById('uploadPreview');
    const previewName = document.getElementById('previewName');
    const previewSize = document.getElementById('previewSize');
    const progressFill = document.getElementById('progressFill');
    const userCard = document.getElementById('userCard');
    const userName = document.getElementById('userName');
    const userUsername = document.getElementById('userUsername');
    const userAvatarImg = document.getElementById('userAvatarImg');
    const chatAvatarImg = document.getElementById('chatAvatarImg');
    const chatTitle = document.getElementById('chatTitle');

    // –ú–æ–¥–∞–ª–∫–∏
    const profileOverlay = document.getElementById('profileOverlay');
    const profileModal = document.getElementById('profileModal');
    const modalName = document.getElementById('modalName');
    const modalUsername = document.getElementById('modalUsername');
    const modalAvatarImg = document.getElementById('modalAvatarImg');
    const modalBio = document.getElementById('modalBio');
    const modalMusicList = document.getElementById('modalMusicList');

    // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π
    const recentMessageIds = new Set();

    // ==================== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ====================
    function switchAuthTab(tab) {
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
        
        if (tab === 'login') {
            document.querySelector('.auth-tab[onclick="switchAuthTab(\'login\')"]').classList.add('active');
            document.getElementById('loginForm').classList.add('active');
        } else {
            document.querySelector('.auth-tab[onclick="switchAuthTab(\'register\')"]').classList.add('active');
            document.getElementById('registerForm').classList.add('active');
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    document.getElementById('registerAvatarInput').onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('registerAvatarPlaceholder').style.display = 'none';
                const img = document.getElementById('registerAvatarImage');
                img.src = e.target.result;
                img.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    };

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    async function register() {
        const username = document.getElementById('registerUsername').value.trim();
        const password = document.getElementById('registerPassword').value;
        const name = document.getElementById('registerName').value.trim() || username;
        const bio = document.getElementById('registerBio').value.trim();
        const musicTitle = document.getElementById('registerMusicTitle').value.trim();
        const musicArtist = document.getElementById('registerMusicArtist').value.trim();
        const avatarImg = document.getElementById('registerAvatarImage');

        if (!username || !password) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º –∏ –ø–∞—Ä–æ–ª—å');
            return;
        }

        const userData = {
            username,
            password,
            name,
            bio,
            music_title: musicTitle,
            music_artist: musicArtist
        };

        if (avatarImg && avatarImg.src) {
            userData.avatar = avatarImg.src;
        }

        try {
            const res = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });

            const data = await res.json();

            if (data.error) {
                alert(data.error);
                return;
            }

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            document.getElementById('loginUsername').value = username;
            document.getElementById('loginPassword').value = password;
            login();

        } catch (err) {
            alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
        }
    }

    // –í—Ö–æ–¥
    async function login() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;

        if (!username || !password) {
            alert('–í–≤–µ–¥–∏—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º –∏ –ø–∞—Ä–æ–ª—å');
            return;
        }

        try {
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const data = await res.json();

            if (data.error) {
                alert(data.error);
                return;
            }

            currentUser = data.user;

            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–æ–∫–µ—Ç
            socket.emit('auth', currentUser.id);

            welcomeScreen.classList.add('hidden');
            chatContainer.classList.remove('hidden');
            
            userName.textContent = currentUser.name;
            userUsername.textContent = '@' + currentUser.username;
            userAvatarImg.src = currentUser.avatar || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'50\' fill=\'%232a2a35\'/%3E%3Ctext x=\'50\' y=\'65\' font-size=\'40\' text-anchor=\'middle\' fill=\'%23fff\' dy=\'.3em\'%3EN%3C/text%3E%3C/svg%3E';

            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–≤–æ–¥
            messageInput.disabled = false;
            sendButton.disabled = false;

        } catch (err) {
            alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
        }
    }

    // ==================== –§–ê–ô–õ–´ ====================
    async function handleFileSelect(file) {
        if (!file) return;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (50MB)
        if (file.size > 50 * 1024 * 1024) {
            alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º 50MB)');
            return;
        }

        currentFile = file;
        previewName.textContent = file.name;
        previewSize.textContent = formatFileSize(file.size);
        progressFill.style.width = '0%';
        uploadPreview.classList.remove('hidden');
    }

    async function sendFile() {
        if (!currentFile || !selectedChat) return;

        const formData = new FormData();
        formData.append('file', currentFile);

        try {
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    progressFill.style.width = percent + '%';
                }
            });

            xhr.onload = function() {
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);
                    
                    socket.emit('send-message', {
                        from_id: currentUser.id,
                        to_id: selectedChat.user.id,
                        type: file.type.startsWith('image/') ? 'image' : 
                              file.type.startsWith('video/') ? 'video' : 'file',
                        file: data.file
                    });
                }
                cancelUpload();
            };

            xhr.open('POST', '/api/upload', true);
            xhr.send(formData);

        } catch (err) {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            cancelUpload();
        }
    }

    function cancelUpload() {
        currentFile = null;
        uploadPreview.classList.add('hidden');
        progressFill.style.width = '0%';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 –ë';
        const k = 1024;
        const sizes = ['–ë', '–ö–ë', '–ú–ë', '–ì–ë'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // ==================== –ü–û–ò–°–ö ====================
    function searchUsers() {
        const query = document.getElementById('searchInput').value.trim();
        if (query.length < 2) {
            document.getElementById('searchResults').innerHTML = '';
            return;
        }

        socket.emit('search-users', query);
    }

    // ==================== –ß–ê–¢–´ ====================
    function startChat(user) {
        let chat = chats.find(c => c.user.id === user.id);
        if (!chat) {
            chat = {
                id: 'chat_' + user.id,
                user: user,
                messages: [],
                lastMessage: '',
                page: 1,
                hasMore: true
            };
            chats.unshift(chat);
        }

        selectedChat = chat;
        updateChatsList();
        showChat(chat);
        
        document.getElementById('searchInput').value = '';
        document.getElementById('searchResults').innerHTML = '';
    }

    function updateChatsList() {
        const list = document.getElementById('chatsList');
        list.innerHTML = chats.map(c => `
            <div class="chat-item ${selectedChat?.id === c.id ? 'selected' : ''}" onclick="selectChat('${c.id}')">
                <div class="user-avatar small"><img src="${c.user.avatar || ''}"></div>
                <div class="chat-info">
                    <div class="chat-name">${c.user.name}</div>
                    <div class="chat-last-message">${c.lastMessage || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                </div>
            </div>
        `).join('');
    }

    function selectChat(chatId) {
        const chat = chats.find(c => c.id === chatId);
        if (chat) {
            selectedChat = chat;
            showChat(chat);
        }
    }

    function showChat(chat) {
        chatTitle.textContent = chat.user.name;
        chatAvatarImg.src = chat.user.avatar || '';
        
        messagesArea.innerHTML = '<div class="system-message">–ß–∞—Ç —Å @' + chat.user.username + '</div>';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        loadMessages(chat, 1);
    }

    async function loadMessages(chat, page) {
        if (loading || !chat.hasMore) return;
        
        loading = true;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        const loader = document.createElement('div');
        loader.className = 'loader-container';
        loader.innerHTML = '<div class="loading"></div>';
        messagesArea.insertBefore(loader, messagesArea.firstChild);

        try {
            const res = await fetch(`/api/messages/${currentUser.id}/${chat.user.id}?page=${page}`);
            const messages = await res.json();

            loader.remove();

            if (messages.length === 0) {
                chat.hasMore = false;
                return;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –Ω–∞—á–∞–ª–æ
            messages.forEach(msg => {
                const msgDiv = createMessageElement(msg);
                messagesArea.insertBefore(msgDiv, messagesArea.firstChild.nextSibling);
            });

            chat.page = page;
            chat.hasMore = messages.length === 50;

        } catch (err) {
            loader.remove();
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', err);
        }

        loading = false;
    }

    // –ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
    messagesArea.addEventListener('scroll', () => {
        if (messagesArea.scrollTop < 100 && selectedChat && !loading && selectedChat.hasMore) {
            loadMessages(selectedChat, selectedChat.page + 1);
        }
    });

    // ==================== –°–û–û–ë–©–ï–ù–ò–Ø ====================
    function sendMessage() {
        const text = messageInput.value.trim();

        if (currentFile) {
            sendFile();
        } else if (text && selectedChat) {
            socket.emit('send-message', {
                from_id: currentUser.id,
                to_id: selectedChat.user.id,
                type: 'text',
                text: text
            });
            messageInput.value = '';
        }
    }

    function createMessageElement(msg) {
        const div = document.createElement('div');
        const isOwn = msg.from.id === currentUser.id;
        div.className = `message ${isOwn ? 'own' : ''}`;

        let contentHtml = '';

        if (msg.type === 'text') {
            contentHtml = `<div>${msg.text}</div>`;
        } else if (msg.type === 'image' && msg.file) {
            contentHtml = `
                <div class="file-message">
                    <div class="file-icon">üñºÔ∏è</div>
                    <div class="file-info">
                        <div class="file-name">${msg.file.name}</div>
                        <div class="file-size">${msg.file.size_formatted}</div>
                    </div>
                    <a href="${msg.file.path}" download class="file-download">–°–∫–∞—á–∞—Ç—å</a>
                </div>
                <img src="${msg.file.path}" class="message-image" onclick="window.open(this.src)">
            `;
        } else if (msg.type === 'video' && msg.file) {
            contentHtml = `
                <div class="file-message">
                    <div class="file-icon">üé•</div>
                    <div class="file-info">
                        <div class="file-name">${msg.file.name}</div>
                        <div class="file-size">${msg.file.size_formatted}</div>
                    </div>
                    <a href="${msg.file.path}" download class="file-download">–°–∫–∞—á–∞—Ç—å</a>
                </div>
                <video src="${msg.file.path}" class="message-video" controls></video>
            `;
        } else if (msg.file) {
            contentHtml = `
                <div class="file-message">
                    <div class="file-icon">üìÑ</div>
                    <div class="file-info">
                        <div class="file-name">${msg.file.name}</div>
                        <div class="file-size">${msg.file.size_formatted}</div>
                    </div>
                    <a href="${msg.file.path}" download class="file-download">–°–∫–∞—á–∞—Ç—å</a>
                </div>
            `;
        }

        div.innerHTML = `
            <div class="message-avatar" onclick="showUserProfile('${msg.from.id}')">
                <img src="${msg.from.avatar || ''}" alt="avatar">
            </div>
            <div class="message-content">
                <div class="message-author" onclick="showUserProfile('${msg.from.id}')">
                    ${msg.from.name}
                </div>
                ${contentHtml}
                <div class="message-time">${msg.time || ''}</div>
            </div>
        `;

        return div;
    }

    function addMessage(msg) {
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π
        const msgId = `${msg.from.id}_${msg.text}_${msg.time}`;
        if (recentMessageIds.has(msgId)) return;
        recentMessageIds.add(msgId);

        const div = createMessageElement(msg);
        messagesArea.appendChild(div);
        messagesArea.scrollTop = messagesArea.scrollHeight;

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
        const chat = chats.find(c => c.user.id === (msg.from.id === currentUser.id ? msg.to.id : msg.from.id));
        if (chat) {
            chat.lastMessage = msg.type === 'text' ? msg.text : 'üìé ' + (msg.file?.name || '—Ñ–∞–π–ª');
            updateChatsList();
        }
    }

    // ==================== –ü–†–û–§–ò–õ–ò ====================
    function showMyProfile() {
        modalName.textContent = currentUser.name;
        modalUsername.textContent = '@' + currentUser.username;
        modalAvatarImg.src = currentUser.avatar || '';
        modalBio.textContent = currentUser.bio || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª';
        
        if (currentUser.music) {
            modalMusicList.innerHTML = `
                <div class="profile-music-item">
                    <div class="music-icon">üéµ</div>
                    <div class="music-info">
                        <div class="music-title">${currentUser.music.title}</div>
                        <div class="music-artist">${currentUser.music.artist || ''}</div>
                    </div>
                </div>
            `;
        } else {
            modalMusicList.innerHTML = '<div class="profile-music-item">–ù–µ—Ç –º—É–∑—ã–∫–∏</div>';
        }
        
        profileOverlay.classList.add('active');
        profileModal.classList.add('active');
    }

    function showUserProfile(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;

        modalName.textContent = user.name;
        modalUsername.textContent = '@' + user.username;
        modalAvatarImg.src = user.avatar || '';
        modalBio.textContent = user.bio || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª';
        
        if (user.music) {
            modalMusicList.innerHTML = `
                <div class="profile-music-item">
                    <div class="music-icon">üéµ</div>
                    <div class="music-info">
                        <div class="music-title">${user.music.title}</div>
                        <div class="music-artist">${user.music.artist || ''}</div>
                    </div>
                </div>
            `;
        } else {
            modalMusicList.innerHTML = '<div class="profile-music-item">–ù–µ—Ç –º—É–∑—ã–∫–∏</div>';
        }
        
        profileOverlay.classList.add('active');
        profileModal.classList.add('active');
    }

    function showCurrentChatProfile() {
        if (selectedChat) {
            showUserProfile(selectedChat.user.id);
        }
    }

    function closeProfileModal() {
        profileOverlay.classList.remove('active');
        profileModal.classList.remove('active');
    }

    // ==================== –°–û–ö–ï–¢–´ ====================
    socket.on('search-results', (results) => {
        const resultsDiv = document.getElementById('searchResults');
        
        if (results.length === 0) {
            resultsDiv.innerHTML = '<div class="search-result-item">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            return;
        }

        resultsDiv.innerHTML = results.map(user => `
            <div class="search-result-item" onclick="startChat(${JSON.stringify(user).replace(/"/g, '&quot;')})">
                <div class="user-avatar small"><img src="${user.avatar || ''}"></div>
                <div>
                    <div>${user.name}</div>
                    <div style="font-size:12px; color:#888">@${user.username}</div>
                </div>
            </div>
        `).join('');
    });

    socket.on('new-message', (msg) => {
        addMessage(msg);
    });

    socket.on('online-users', (onlineUsers) => {
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–Ω–ª–∞–π–Ω
    });

    // ==================== –°–û–ë–´–¢–ò–Ø ====================
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });
</script>

</body>
</html>
