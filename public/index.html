<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noqeder</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0c;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ */
        .welcome-screen {
            position: fixed;
            inset: 0;
            background: #0a0a0c;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .hidden {
            display: none !important;
        }

        .auth-card {
            width: 400px;
            padding: 32px;
            background: #12121a;
            border: 2px solid #2a2a35;
            border-radius: 32px;
            text-align: center;
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo span {
            display: inline-block;
            font-size: 48px;
            font-weight: 800;
            letter-spacing: 4px;
            color: #fff;
            background: #000;
            padding: 8px 24px;
            border-radius: 60px;
            border: 2px solid #fff;
        }

        .avatar-upload {
            margin-bottom: 24px;
            text-align: center;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #1a1a24;
            border: 3px solid #2a2a35;
            margin: 0 auto 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .avatar-preview:hover {
            border-color: #fff;
            transform: scale(1.05);
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 24px;
            background: #1a1a24;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #888;
            font-size: 12px;
        }

        .input-group input {
            width: 100%;
            padding: 16px;
            background: #0f0f15;
            border: 2px solid #2a2a35;
            border-radius: 16px;
            color: #fff;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            border-color: #fff;
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: #fff;
            color: #000;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255,255,255,0.2);
        }

        .btn.small {
            padding: 12px;
            font-size: 14px;
            margin-top: 10px;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç */
        .chat-container {
            display: grid;
            grid-template-columns: 360px 1fr;
            height: 100vh;
        }

        .chats-sidebar {
            background: #12121a;
            border-right: 2px solid #2a2a35;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header h2 span {
            background: #000;
            padding: 4px 12px;
            border-radius: 40px;
            border: 2px solid #fff;
            font-size: 20px;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #1a1a24;
            border: 2px solid #2a2a35;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 20px;
            filter: grayscale(100%);
        }

        .icon-btn:hover {
            background: #fff;
            border-color: #fff;
            transform: scale(1.1) rotate(5deg);
            filter: grayscale(0%);
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        .user-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: #1a1a24;
            border-radius: 20px;
            border: 2px solid #2a2a35;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-card:hover {
            border-color: #fff;
            transform: translateX(5px);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #1a1a24;
            border: 2px solid #2a2a35;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-avatar.small {
            width: 36px;
            height: 36px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
        }

        .user-username {
            font-size: 14px;
            color: #888;
        }

        .user-bio {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        /* –ü–æ–∏—Å–∫ */
        .search-section {
            margin-bottom: 10px;
        }

        .search-title {
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .search-container {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            font-size: 16px;
        }

        .search-input {
            width: 100%;
            padding: 14px 14px 14px 48px;
            background: #0f0f15;
            border: 2px solid #2a2a35;
            border-radius: 30px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }

        .search-input:focus {
            border-color: #fff;
        }

        .search-results {
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #1a1a24;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-result-item:hover {
            background: #2a2a35;
            transform: translateX(5px);
        }

        /* –ò–∑–±—Ä–∞–Ω–Ω–æ–µ */
        .favorites-section {
            margin-bottom: 10px;
        }

        .favorites-title {
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
        }

        .favorites-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .favorite-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #1a1a24;
            border-radius: 12px;
            margin-bottom: 6px;
            cursor: pointer;
        }

        .favorite-item:hover {
            background: #2a2a35;
        }

        .favorite-star {
            color: #ffd700;
            margin-right: 8px;
        }

        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        .chats-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #1a1a24;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .chat-item:hover {
            background: #2a2a35;
            transform: translateX(5px);
            border-color: #fff;
        }

        .chat-item.selected {
            border-color: #fff;
            background: #2a2a35;
        }

        .chat-info {
            flex: 1;
            margin-left: 12px;
        }

        .chat-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-last-message {
            font-size: 13px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç */
        .chat-main {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 2px solid #2a2a35;
            background: #12121a;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .messages-area {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
        }

        .message {
            max-width: 70%;
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease;
        }

        .message.own {
            align-self: flex-end;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #1a1a24;
            border: 2px solid #2a2a35;
            overflow: hidden;
            cursor: pointer;
            flex-shrink: 0;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            background: #1a1a24;
            padding: 12px 16px;
            border-radius: 20px;
            word-break: break-word;
        }

        .message.own .message-content {
            background: #fff;
            color: #000;
        }

        .message-author {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 4px;
            font-weight: 600;
            cursor: pointer;
        }

        .message.own .message-author {
            color: #666;
        }

        .message-time {
            font-size: 10px;
            color: #888;
            margin-top: 4px;
            text-align: right;
        }

        /* –§–∞–π–ª—ã */
        .file-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin: 4px 0;
        }

        .file-icon {
            font-size: 32px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-size: 14px;
            font-weight: 500;
        }

        .file-size {
            font-size: 12px;
            color: #888;
        }

        .file-download {
            padding: 6px 12px;
            background: #fff;
            color: #000;
            border-radius: 20px;
            text-decoration: none;
            font-size: 12px;
        }

        .message-image {
            max-width: 300px;
            max-height: 200px;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 4px;
        }

        .message-video {
            max-width: 300px;
            max-height: 200px;
            border-radius: 12px;
            margin-top: 4px;
        }

        .system-message {
            text-align: center;
            font-size: 12px;
            color: #888;
            padding: 8px 16px;
            background: #1a1a24;
            border-radius: 40px;
            align-self: center;
        }

        /* –ö–æ–º–ø–æ–∑–µ—Ä */
        .composer {
            padding: 20px;
            border-top: 2px solid #2a2a35;
            background: #12121a;
            flex-shrink: 0;
        }

        .composer-tools {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .media-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #1a1a24;
            border: 2px solid #2a2a35;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            filter: grayscale(100%);
        }

        .media-btn:hover {
            background: #fff;
            border-color: #fff;
            transform: scale(1.1);
            filter: grayscale(0%);
        }

        .composer-row {
            display: flex;
            gap: 12px;
        }

        .composer input {
            flex: 1;
            padding: 16px 20px;
            background: #0f0f15;
            border: 2px solid #2a2a35;
            border-radius: 30px;
            color: #fff;
            font-size: 16px;
            outline: none;
        }

        .composer input:focus {
            border-color: #fff;
        }

        .composer button {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            border: none;
            background: #fff;
            cursor: pointer;
            font-size: 24px;
        }

        .composer button:hover {
            transform: scale(1.1);
        }

        .upload-preview {
            margin-top: 12px;
            padding: 12px;
            background: #1a1a24;
            border: 2px solid #2a2a35;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .upload-preview.hidden {
            display: none;
        }

        .preview-cancel {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #ff4444;
            color: white;
            border: none;
            cursor: pointer;
        }

        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .profile-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 450px;
            background: #12121a;
            border: 2px solid #2a2a35;
            border-radius: 32px;
            padding: 32px;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .profile-modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .profile-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .profile-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid #fff;
            overflow: hidden;
        }

        .profile-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-title h3 {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .profile-title .username {
            color: #888;
            font-size: 14px;
        }

        .profile-section {
            margin-bottom: 24px;
        }

        .profile-section-title {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .profile-bio {
            background: #1a1a24;
            padding: 16px;
            border-radius: 16px;
            font-size: 14px;
            border: 2px solid #2a2a35;
        }

        .profile-music-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #1a1a24;
            border-radius: 16px;
            border: 2px solid #2a2a35;
        }

        .edit-field {
            margin-bottom: 16px;
        }

        .edit-field label {
            display: block;
            margin-bottom: 8px;
            color: #888;
            font-size: 12px;
        }

        .edit-field input,
        .edit-field textarea {
            width: 100%;
            padding: 12px;
            background: #0f0f15;
            border: 2px solid #2a2a35;
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }
    </style>
</head>
<body>

<!-- –û–≤–µ—Ä–ª–µ–π –ø—Ä–æ—Ñ–∏–ª—è -->
<div class="profile-overlay" id="profileOverlay" onclick="closeProfileModal()"></div>
<div class="profile-modal" id="profileModal">
    <div class="profile-header">
        <div class="profile-avatar-large" id="modalAvatar">
            <img src="" id="modalAvatarImg">
        </div>
        <div class="profile-title">
            <h3 id="modalName"></h3>
            <div class="username" id="modalUsername"></div>
        </div>
    </div>

    <div class="profile-section">
        <div class="profile-section-title">–û –°–ï–ë–ï</div>
        <div class="profile-bio" id="modalBio"></div>
    </div>

    <div class="profile-section">
        <div class="profile-section-title">–ú–£–ó–´–ö–ê</div>
        <div id="modalMusicList"></div>
    </div>

    <!-- –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="editMode" style="display: none;">
        <div class="edit-field">
            <label>–û–ü–ò–°–ê–ù–ò–ï</label>
            <textarea id="editBioInput" rows="3"></textarea>
        </div>
        <div class="edit-field">
            <label>–ù–ê–ó–í–ê–ù–ò–ï –¢–†–ï–ö–ê</label>
            <input type="text" id="editMusicTitle">
        </div>
        <div class="edit-field">
            <label>–ò–°–ü–û–õ–ù–ò–¢–ï–õ–¨</label>
            <input type="text" id="editMusicArtist">
        </div>
        <button class="btn small" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn small" onclick="cancelEdit()" style="background: #333;">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <button class="btn small" id="editProfileBtn" onclick="startEdit()" style="margin-top: 20px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    <button class="btn small" onclick="closeProfileModal()" style="margin-top: 10px; background: #333;">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
<div class="welcome-screen" id="welcomeScreen">
    <div class="auth-card">
        <div class="logo"><span>NOQEDER</span></div>
        
        <div class="avatar-upload">
            <div class="avatar-preview" id="avatarPreview" onclick="document.getElementById('avatarInput').click()">
                <div class="avatar-placeholder" id="avatarPlaceholder">+</div>
                <img id="avatarImage" src="" style="display: none;">
            </div>
            <div class="avatar-hint">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</div>
            <input type="file" id="avatarInput" accept="image/*" style="display: none;">
        </div>

        <div class="input-group">
            <label>–Æ–ó–ï–†–ù–ï–ô–ú</label>
            <input id="username" placeholder="@username">
        </div>
        <div class="input-group">
            <label>–ü–ê–†–û–õ–¨</label>
            <input type="password" id="password">
        </div>
        <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>
    </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
<div class="chat-container hidden" id="chatContainer">
    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="chats-sidebar">
        <div class="sidebar-header">
            <h2><span>NOQEDER</span></h2>
            <div class="icon-btn" onclick="openSettings()">‚öôÔ∏è</div>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="user-card" id="userCard" onclick="showMyProfile()">
            <div class="user-avatar" id="userAvatar">
                <img src="" id="userAvatarImg">
            </div>
            <div class="user-info">
                <div class="user-name" id="userName"></div>
                <div class="user-username" id="userUsername"></div>
                <div class="user-bio" id="userBioDisplay"></div>
            </div>
        </div>

        <!-- –ò–∑–±—Ä–∞–Ω–Ω–æ–µ -->
        <div class="favorites-section">
            <div class="favorites-title">
                <span>‚≠ê –ò–ó–ë–†–ê–ù–ù–û–ï</span>
                <span id="favoritesCount">0</span>
            </div>
            <div class="favorites-list" id="favoritesList"></div>
        </div>

        <!-- –ü–æ–∏—Å–∫ -->
        <div class="search-section">
            <div class="search-title">–ù–ê–ô–¢–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø</div>
            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" id="searchInput" placeholder="@username" oninput="searchUsers()">
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
        <div class="chats-list" id="chatsList"></div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="chat-main">
        <div class="chat-header">
            <div class="header-left" onclick="showCurrentChatProfile()">
                <div class="user-avatar small" id="chatAvatar">
                    <img src="" id="chatAvatarImg">
                </div>
                <span id="chatTitle">–û–±—â–∏–π —á–∞—Ç</span>
            </div>
        </div>

        <div class="messages-area" id="messagesArea">
            <div class="system-message">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Noqeder</div>
        </div>

        <div class="composer">
            <div class="composer-tools">
                <div class="media-btn" onclick="document.getElementById('fileInput').click()">üìÅ</div>
                <div class="media-btn" onclick="document.getElementById('imageInput').click()">üñºÔ∏è</div>
                <div class="media-btn" onclick="document.getElementById('videoInput').click()">üé•</div>
            </div>

            <input type="file" id="fileInput" style="display: none" onchange="handleFileSelect(this.files[0])">
            <input type="file" id="imageInput" style="display: none" accept="image/*" onchange="handleFileSelect(this.files[0])">
            <input type="file" id="videoInput" style="display: none" accept="video/*" onchange="handleFileSelect(this.files[0])">

            <div class="upload-preview hidden" id="uploadPreview">
                <div class="file-icon">üìÑ</div>
                <div class="preview-info">
                    <div class="preview-name" id="previewName"></div>
                    <div class="preview-size" id="previewSize"></div>
                </div>
                <button class="preview-cancel" onclick="cancelUpload()">‚úï</button>
            </div>

            <div class="composer-row">
                <input id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" autocomplete="off">
                <button onclick="sendMessage()">‚Üí</button>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let currentUser = null;
    let currentFile = null;
    let users = [];
    let chats = [];
    let selectedChat = null;
    let favorites = JSON.parse(localStorage.getItem('favorites')) || [];

    // –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
    let profileBio = localStorage.getItem('profileBio') || '';
    let profileMusic = JSON.parse(localStorage.getItem('profileMusic')) || {
        title: '',
        artist: ''
    };

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const welcomeScreen = document.getElementById('welcomeScreen');
    const chatContainer = document.getElementById('chatContainer');
    const messagesArea = document.getElementById('messagesArea');
    const messageInput = document.getElementById('messageInput');
    const uploadPreview = document.getElementById('uploadPreview');
    const previewName = document.getElementById('previewName');
    const previewSize = document.getElementById('previewSize');
    const userCard = document.getElementById('userCard');
    const userName = document.getElementById('userName');
    const userUsername = document.getElementById('userUsername');
    const userAvatarImg = document.getElementById('userAvatarImg');
    const chatAvatarImg = document.getElementById('chatAvatarImg');
    const chatTitle = document.getElementById('chatTitle');
    const userBioDisplay = document.getElementById('userBioDisplay');
    const favoritesList = document.getElementById('favoritesList');
    const favoritesCount = document.getElementById('favoritesCount');

    // –ú–æ–¥–∞–ª–∫–∏
    const profileOverlay = document.getElementById('profileOverlay');
    const profileModal = document.getElementById('profileModal');
    const modalName = document.getElementById('modalName');
    const modalUsername = document.getElementById('modalUsername');
    const modalAvatarImg = document.getElementById('modalAvatarImg');
    const modalBio = document.getElementById('modalBio');
    const modalMusicList = document.getElementById('modalMusicList');
    const editMode = document.getElementById('editMode');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const editBioInput = document.getElementById('editBioInput');
    const editMusicTitle = document.getElementById('editMusicTitle');
    const editMusicArtist = document.getElementById('editMusicArtist');

    // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π
    const recentMessageIds = new Set();

    // ==================== –ê–í–ê–¢–ê–†–ö–ê ====================
    document.getElementById('avatarInput').onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatarPlaceholder').style.display = 'none';
                document.getElementById('avatarImage').src = e.target.result;
                document.getElementById('avatarImage').style.display = 'block';
                localStorage.setItem('tempAvatar', e.target.result);
            };
            reader.readAsDataURL(file);
        }
    };

    // ==================== –ü–†–û–§–ò–õ–¨ ====================
    function showMyProfile() {
        modalName.textContent = currentUser.name;
        modalUsername.textContent = '@' + currentUser.username;
        modalAvatarImg.src = currentUser.avatar;
        modalBio.textContent = profileBio || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª';
        
        if (profileMusic.title) {
            modalMusicList.innerHTML = `
                <div class="profile-music-item">
                    <div class="music-icon">üéµ</div>
                    <div class="music-info">
                        <div class="music-title">${profileMusic.title}</div>
                        <div class="music-artist">${profileMusic.artist || ''}</div>
                    </div>
                </div>
            `;
        } else {
            modalMusicList.innerHTML = '<div class="profile-music-item">–ù–µ—Ç –º—É–∑—ã–∫–∏</div>';
        }
        
        editProfileBtn.style.display = 'block';
        profileOverlay.classList.add('active');
        profileModal.classList.add('active');
    }

    function showUserProfile(user) {
        modalName.textContent = user.name;
        modalUsername.textContent = '@' + user.username;
        modalAvatarImg.src = user.avatar;
        modalBio.textContent = user.bio || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª';
        
        if (user.music && user.music.title) {
            modalMusicList.innerHTML = `
                <div class="profile-music-item">
                    <div class="music-icon">üéµ</div>
                    <div class="music-info">
                        <div class="music-title">${user.music.title}</div>
                        <div class="music-artist">${user.music.artist || ''}</div>
                    </div>
                </div>
            `;
        } else {
            modalMusicList.innerHTML = '<div class="profile-music-item">–ù–µ—Ç –º—É–∑—ã–∫–∏</div>';
        }
        
        editProfileBtn.style.display = 'none';
        profileOverlay.classList.add('active');
        profileModal.classList.add('active');
    }

    function showCurrentChatProfile() {
        if (selectedChat) {
            showUserProfile(selectedChat.user);
        }
    }

    function closeProfileModal() {
        profileOverlay.classList.remove('active');
        profileModal.classList.remove('active');
        editMode.style.display = 'none';
        editProfileBtn.style.display = 'block';
    }

    function startEdit() {
        editBioInput.value = profileBio;
        editMusicTitle.value = profileMusic.title || '';
        editMusicArtist.value = profileMusic.artist || '';
        
        editMode.style.display = 'block';
        editProfileBtn.style.display = 'none';
    }

    function cancelEdit() {
        editMode.style.display = 'none';
        editProfileBtn.style.display = 'block';
    }

    function saveProfile() {
        profileBio = editBioInput.value.trim();
        profileMusic = {
            title: editMusicTitle.value.trim(),
            artist: editMusicArtist.value.trim()
        };
        
        localStorage.setItem('profileBio', profileBio);
        localStorage.setItem('profileMusic', JSON.stringify(profileMusic));
        
        modalBio.textContent = profileBio;
        userBioDisplay.textContent = profileBio ? `üìù ${profileBio.substring(0, 30)}...` : '';
        
        if (currentUser) {
            currentUser.bio = profileBio;
            currentUser.music = profileMusic;
            socket.emit('update-profile', currentUser);
        }
        
        editMode.style.display = 'none';
        editProfileBtn.style.display = 'block';
    }

    // ==================== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ====================
    function login() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;

        if (!username || !password) {
            alert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è');
            return;
        }

        const avatar = localStorage.getItem('tempAvatar') || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'50\' fill=\'%232a2a35\'/%3E%3Ctext x=\'50\' y=\'65\' font-size=\'40\' text-anchor=\'middle\' fill=\'%23fff\' dy=\'.3em\'%3EN%3C/text%3E%3C/svg%3E';

        currentUser = {
            id: socket.id,
            name: username,
            username: username,
            avatar: avatar,
            bio: profileBio,
            music: profileMusic
        };

        socket.emit('new-user', currentUser);

        welcomeScreen.classList.add('hidden');
        chatContainer.classList.remove('hidden');
        
        userCard.classList.remove('hidden');
        userName.textContent = username;
        userUsername.textContent = '@' + username;
        userAvatarImg.src = avatar;
        userBioDisplay.textContent = profileBio ? `üìù ${profileBio.substring(0, 30)}...` : '';
        
        localStorage.removeItem('tempAvatar');
    }

    // ==================== –§–ê–ô–õ–´ ====================
    function handleFileSelect(file) {
        if (!file) return;
        currentFile = file;
        previewName.textContent = file.name;
        previewSize.textContent = formatFileSize(file.size);
        uploadPreview.classList.remove('hidden');
    }

    function cancelUpload() {
        currentFile = null;
        uploadPreview.classList.add('hidden');
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 –ë';
        const k = 1024;
        const sizes = ['–ë', '–ö–ë', '–ú–ë', '–ì–ë'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // ==================== –ü–û–ò–°–ö (–ò–°–ü–†–ê–í–õ–ï–ù!) ====================
    function searchUsers() {
        const query = document.getElementById('searchInput').value.trim().toLowerCase();
        const results = document.getElementById('searchResults');
        
        results.innerHTML = ''; // –û—á–∏—â–∞–µ–º
        
        if (!query || !users.length) return;

        // –ò—â–µ–º –¢–û–õ–¨–ö–û –ø–æ username
        const found = users.filter(u => 
            u.id !== currentUser?.id && 
            u.username && 
            u.username.toLowerCase().includes(query)
        );

        if (found.length === 0) {
            results.innerHTML = '<div class="search-result-item" style="justify-content: center;">–ù–∏–∫–æ–≥–æ –Ω–µ—Ç</div>';
            return;
        }

        results.innerHTML = found.map(u => `
            <div class="search-result-item" onclick="startChat('${u.id}')">
                <div class="user-avatar small"><img src="${u.avatar}"></div>
                <div>
                    <div style="font-weight:500">${u.name}</div>
                    <div style="font-size:12px; color:#888">@${u.username}</div>
                </div>
            </div>
        `).join('');
    }

    // ==================== –ò–ó–ë–†–ê–ù–ù–û–ï ====================
    function toggleFavorite(userId) {
        const index = favorites.indexOf(userId);
        if (index === -1) {
            favorites.push(userId);
        } else {
            favorites.splice(index, 1);
        }
        localStorage.setItem('favorites', JSON.stringify(favorites));
        updateFavoritesList();
        updateChatsList();
    }

    function isFavorite(userId) {
        return favorites.includes(userId);
    }

    function updateFavoritesList() {
        const favUsers = users.filter(u => favorites.includes(u.id) && u.id !== currentUser?.id);
        favoritesCount.textContent = favUsers.length;

        if (favUsers.length === 0) {
            favoritesList.innerHTML = '<div class="favorite-item" style="justify-content: center;">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö</div>';
            return;
        }

        favoritesList.innerHTML = favUsers.map(user => `
            <div class="favorite-item" onclick="startChat('${user.id}')">
                <span class="favorite-star">‚≠ê</span>
                <div class="user-avatar small"><img src="${user.avatar}"></div>
                <div>${user.name}</div>
            </div>
        `).join('');
    }

    // ==================== –ß–ê–¢–´ ====================
    function startChat(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;

        let chat = chats.find(c => c.user.id === userId);
        if (!chat) {
            chat = {
                id: 'chat_' + Date.now(),
                user: user,
                messages: [],
                lastMessage: ''
            };
            chats.unshift(chat);
        }

        selectedChat = chat;
        updateChatsList();
        showChat(chat);
        
        document.getElementById('searchInput').value = '';
        document.getElementById('searchResults').innerHTML = '';
    }

    function updateChatsList() {
        const list = document.getElementById('chatsList');
        list.innerHTML = chats.map(c => {
            const isFav = isFavorite(c.user.id);
            return `
                <div class="chat-item ${selectedChat?.id === c.id ? 'selected' : ''}" onclick="selectChat('${c.id}')">
                    <div class="user-avatar small"><img src="${c.user.avatar}"></div>
                    <div class="chat-info">
                        <div class="chat-name">
                            ${c.user.name}
                            ${isFav ? '<span style="color:#ffd700">‚≠ê</span>' : ''}
                        </div>
                        <div class="chat-last-message">${c.lastMessage || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function selectChat(chatId) {
        const chat = chats.find(c => c.id === chatId);
        if (chat) {
            selectedChat = chat;
            showChat(chat);
        }
    }

    function showChat(chat) {
        chatTitle.textContent = chat.user.name;
        chatAvatarImg.src = chat.user.avatar;
        
        messagesArea.innerHTML = '<div class="system-message">–ß–∞—Ç —Å @' + chat.user.username + '</div>';
        chat.messages.forEach(msg => addMessage(msg));
    }

    // ==================== –û–¢–ü–†–ê–í–ö–ê ====================
    function sendMessage() {
        const text = messageInput.value.trim();

        if (currentFile) {
            sendFile(currentFile);
            cancelUpload();
        } else if (text && currentUser) {
            const msg = {
                type: 'text',
                text: text,
                user: currentUser,
                time: new Date().toLocaleTimeString()
            };

            if (selectedChat) {
                msg.to = selectedChat.user;
                socket.emit('private-message', msg);
                
                selectedChat.messages.push(msg);
                selectedChat.lastMessage = text;
                updateChatsList();
                addMessage(msg);
            } else {
                socket.emit('message', msg);
                addMessage(msg);
            }
            
            messageInput.value = '';
        }
    }

    function sendFile(file) {
        const reader = new FileReader();

        reader.onload = function(e) {
            const fileData = {
                name: file.name,
                size: file.size,
                type: file.type,
                data: e.target.result,
                user: currentUser
            };

            let messageType = 'file';
            if (file.type.startsWith('image/')) messageType = 'image';
            else if (file.type.startsWith('video/')) messageType = 'video';

            const msg = {
                type: messageType,
                file: fileData,
                user: currentUser,
                time: new Date().toLocaleTimeString()
            };

            if (selectedChat) {
                msg.to = selectedChat.user;
                socket.emit('private-message', msg);
                
                selectedChat.messages.push(msg);
                selectedChat.lastMessage = 'üìé ' + file.name;
                updateChatsList();
                addMessage(msg);
            } else {
                socket.emit('message', msg);
                addMessage(msg);
            }
        };

        reader.readAsDataURL(file);
    }

    // ==================== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï (–ò–°–ü–†–ê–í–õ–ï–ù–û!) ====================
    function addMessage(msg) {
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
        const msgId = `${msg.user?.id || msg.from?.id}_${msg.text}_${msg.time}`;
        if (recentMessageIds.has(msgId)) return;
        recentMessageIds.add(msgId);
        
        // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö ID
        if (recentMessageIds.size > 100) {
            const toDelete = Array.from(recentMessageIds).slice(0, 50);
            toDelete.forEach(id => recentMessageIds.delete(id));
        }

        const div = document.createElement('div');
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        let messageUser = msg.user || msg.from;
        const isOwn = currentUser && messageUser?.id === currentUser.id;
        
        div.className = `message ${isOwn ? 'own' : ''}`;

        let contentHtml = '';

        if (msg.type === 'text' || !msg.type) {
            contentHtml = `<div>${msg.text || msg}</div>`;
        } else if (msg.type === 'image' && msg.file) {
            contentHtml = `
                <div class="file-message">
                    <div class="file-icon">üñºÔ∏è</div>
                    <div class="file-info">
                        <div class="file-name">${msg.file.name}</div>
                        <div class="file-size">${formatFileSize(msg.file.size)}</div>
                    </div>
                    <a href="${msg.file.data}" download="${msg.file.name}" class="file-download">–°–∫–∞—á–∞—Ç—å</a>
                </div>
                <img src="${msg.file.data}" class="message-image" onclick="window.open(this.src)">
            `;
        } else if (msg.type === 'video' && msg.file) {
            contentHtml = `
                <div class="file-message">
                    <div class="file-icon">üé•</div>
                    <div class="file-info">
                        <div class="file-name">${msg.file.name}</div>
                        <div class="file-size">${formatFileSize(msg.file.size)}</div>
                    </div>
                    <a href="${msg.file.data}" download="${msg.file.name}" class="file-download">–°–∫–∞—á–∞—Ç—å</a>
                </div>
                <video src="${msg.file.data}" class="message-video" controls></video>
            `;
        } else if (msg.file) {
            contentHtml = `
                <div class="file-message">
                    <div class="file-icon">üìÑ</div>
                    <div class="file-info">
                        <div class="file-name">${msg.file.name}</div>
                        <div class="file-size">${formatFileSize(msg.file.size)}</div>
                    </div>
                    <a href="${msg.file.data}" download="${msg.file.name}" class="file-download">–°–∫–∞—á–∞—Ç—å</a>
                </div>
            `;
        }

        div.innerHTML = `
            <div class="message-avatar" onclick="showUserProfileFromMessage('${messageUser?.id}')">
                <img src="${messageUser?.avatar || ''}" alt="avatar">
            </div>
            <div class="message-content">
                <div class="message-author" onclick="showUserProfileFromMessage('${messageUser?.id}')">
                    ${messageUser?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                </div>
                ${contentHtml}
                <div class="message-time">${msg.time || ''}</div>
            </div>
        `;

        messagesArea.appendChild(div);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    function showUserProfileFromMessage(userId) {
        if (!userId) return;
        const user = users.find(u => u.id === userId);
        if (user) {
            if (user.id === currentUser.id) {
                showMyProfile();
            } else {
                showUserProfile(user);
            }
        }
    }

    // ==================== –ù–ê–°–¢–†–û–ô–ö–ò ====================
    function openSettings() {
        alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—è–≤—è—Ç—Å—è —Å–∫–æ—Ä–æ');
    }

    // ==================== –°–û–ö–ï–¢–´ ====================
    socket.on('users', (data) => {
        users = data;
        updateFavoritesList();
    });

    socket.on('message', (msg) => {
        addMessage(msg);
    });

    socket.on('private-message', (msg) => {
        const from = msg.from.id === currentUser.id ? msg.to : msg.from;
        
        let chat = chats.find(c => c.user.id === from.id);
        
        if (!chat) {
            chat = {
                id: 'chat_' + Date.now(),
                user: from,
                messages: [msg],
                lastMessage: msg.type === 'text' ? msg.text : 'üìé ' + (msg.file?.name || '—Ñ–∞–π–ª')
            };
            chats.unshift(chat);
        } else {
            chat.messages.push(msg);
            chat.lastMessage = msg.type === 'text' ? msg.text : 'üìé ' + (msg.file?.name || '—Ñ–∞–π–ª');
            const index = chats.indexOf(chat);
            if (index > 0) {
                chats.splice(index, 1);
                chats.unshift(chat);
            }
        }

        updateChatsList();
        if (selectedChat?.user.id === from.id) addMessage(msg);
    });

    socket.on('history', (msgs) => {
        messagesArea.innerHTML = '<div class="system-message">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Noqeder</div>';
        msgs.forEach(addMessage);
    });

    socket.on('update-profile', (user) => {
        const index = users.findIndex(u => u.id === user.id);
        if (index !== -1) {
            users[index].bio = user.bio;
            users[index].music = user.music;
        }
    });

    // ==================== –°–û–ë–´–¢–ò–Ø ====================
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });

    messageInput.addEventListener('input', () => {
        if (messageInput.value.trim() && currentFile) {
            cancelUpload();
        }
    });
</script>

</body>
</html>
